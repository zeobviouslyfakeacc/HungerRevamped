using System.Collections.Generic;
using System.Reflection;
using System.Reflection.Emit;
using Harmony;

namespace HungerRevamped {

	/*
	 * The cooking skill can be exploited by creating many small pieces of meat and cooking them individually.
	 * Each of these cooking actions yields one skill point, just as if the player cooked a full 1kg piece of meat.
	 * Using this exploit, a player can advance the cooking skill from level 1 to level 5 with just one or two
	 * deer carcasses.
	 *
	 * I've also disabled gaining skill points for cooking ruined items.
	 */

	internal static class Watch_PickUpCookedGearItem {
		internal static bool isExecuting = false;
		internal static bool shouldGivePoint = false;
		internal static CookingPotItem cookingPot = null;
		internal static SkillsManager.PointAssignmentMode mode;
		internal static int numPoints = 0;
		internal static SkillType skillType = SkillType.Cooking;
    }

	[HarmonyPatch(typeof(CookingPotItem), "PickUpCookedGearItem")]
	internal static class ExploitableCookingSkillFix {
		private static void Prefix(CookingPotItem __instance) {
			if (!MenuSettings.settings.fixCookingSkillExploit) return;
			Watch_PickUpCookedGearItem.isExecuting = true;
			Watch_PickUpCookedGearItem.shouldGivePoint = false;
			Watch_PickUpCookedGearItem.cookingPot = __instance;
        }
		private static void Postfix() {
			if (!MenuSettings.settings.fixCookingSkillExploit) return;
			Watch_PickUpCookedGearItem.isExecuting = false;
			Watch_PickUpCookedGearItem.cookingPot = null;
			if (Watch_PickUpCookedGearItem.shouldGivePoint) {
				Watch_PickUpCookedGearItem.shouldGivePoint = false;
				GameManager.GetSkillsManager().IncrementPointsAndNotify(Watch_PickUpCookedGearItem.skillType,Watch_PickUpCookedGearItem.numPoints,Watch_PickUpCookedGearItem.mode);
			}
		}
	}

	[HarmonyPatch(typeof(SkillsManager),"IncrementPointsAndNotify")]
	internal class Incrementskill {
		private static bool Prefix(SkillType skillType, int numPoints, SkillsManager.PointAssignmentMode mode) {
			if (!MenuSettings.settings.fixCookingSkillExploit) return true;
			if (Watch_PickUpCookedGearItem.isExecuting) {
				Watch_PickUpCookedGearItem.shouldGivePoint = CheckFoodItem(Watch_PickUpCookedGearItem.cookingPot);
				Watch_PickUpCookedGearItem.skillType = skillType;
				Watch_PickUpCookedGearItem.numPoints = numPoints;
				Watch_PickUpCookedGearItem.mode = mode;
				return false;
			} else return true;
        }
		private static bool CheckFoodItem(CookingPotItem pot) {
			GearItem itemBeingCooked = pot?.m_GearItemBeingCooked;
			if (itemBeingCooked && itemBeingCooked.IsWornOut()) {
				return false; // No skill points for cooking ruined items
			} else if (itemBeingCooked && itemBeingCooked.m_FoodItem) {
				FoodItem food = itemBeingCooked.m_FoodItem;
				if (food.m_IsMeat) {
					return Utils.RollChance(100f * food.m_CaloriesRemaining / food.m_CaloriesTotal);
				}
			}
			return true;
		}
	}
}
